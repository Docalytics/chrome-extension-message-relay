/* Version 1.1.0 chrome-extension-message-relay (https://github.com/ecaroth/chrome-extension-message-relay), Authored by Evan Carothers */

"use strict";!function(){var e=function(e,n,t){function i(e,n){"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++){var i=a(e[t]);i.type in D||(D[i.type]=[]),D[i.type].push({fn:n,ns:i.namespace})}}function s(e){"string"==typeof e&&(e=[e]);for(var n=0;n<e.length;n++){var t=a(e[n]);t.type in D&&(t.namespace?o(t.type,t.namespace):delete D[t.type])}}function a(e){var n=e.split(".");return{type:n.splice(0,1)[0],namespace:n.length>0?n.join("."):null}}function o(e,n){if(e in D)for(var t=D[e].length-1;t>=0;t--)D[e][t].ns===n&&D[e].splice(t,1)}function r(e){if(e)for(var n in D)o(n,e);else D={}}function f(e,n,t,i){i||(i={});var s="msg_id"in i?i.msg_id:n+":"+e+":"+(new Date).getTime();i.msg_id=s;var a={msg_type:e,msg_from:N,msg_destination:n,msg_up:t,msg_namespace:L,msg_data:i,msg_id:s,msg_tab_id:null},o=v(n);return o.tab_id&&(a.msg_destination=o.level,a.msg_tab_id=o.tab_id),a}function m(e,n,t,i){"string"==typeof n&&(n=[n]);for(var s=0;s<n.length;s++)if(_(n[s])){var a=v(n[s]).level;S[a]<S[N]?g(e,n[s],t,i):c(e,n[s],t,i)}else h("NOTICE - invalid level specified as destination ("+n[s]+")")}function g(e,n,t,i){var s=f(e,n,!1,t);h("Send msg DOWN from "+N+" to "+n+" : "+e+" - "+JSON.stringify(t)),u(s,i)}function c(e,n,t,i){var s=f(e,n,!0,t);h("Send msg UP from "+N+" to "+n+" : "+e+" - "+JSON.stringify(t)),u(s,i)}function l(e,n,t){if(e===O.extension&&S[n.msg_destination]<S.extension)chrome.tabs.query({},function(e){for(var i=0;i<e.length;i++)n.msg_tab_id&&e[i].id!==n.msg_tab_id||chrome.tabs.sendMessage(e[i].id,n,function(e){t&&t(e)})});else if(e===O.content&&n.msg_destination===O.extension||e===O.extension)chrome.runtime.sendMessage(n,function(e){t&&"function"==typeof t&&t(e)});else if(e===O.iframe||e===O.iframe_shim)window.parent.postMessage(n,"*");else if(e!==O.page&&e!==O.content||n.msg_destination!==O.iframe)window.postMessage(n,"*");else for(var i=document.getElementsByTagName("iframe"),s=0;s<i.length;s++)try{i[s].contentWindow.postMessage(n,"*")}catch(a){}}function u(e,n){l(N,e,n)}function d(e,n,t){e=JSON.parse(JSON.stringify(e));var i=e.msg_data,s=e.msg_from,a=e.msg_up,o=e.msg_destination,r=e.msg_type,f=e.msg_id;t&&(T=t),E=r;var m=f+":"+o;return!(s===N||m in w)&&(o===N?(h("Msg ("+r+") received from "+s+" to "+o+" - "+JSON.stringify(i)),w[m]=0,p(r,i,t,n)):(e.msg_from=N,a&&S[N]>S[s]?(u(e),h("Msg ("+r+") relaying UP from "+s+" to "+o+" - "+JSON.stringify(i))):!a&&S[N]<S[s]&&(u(e),h("Msg ("+r+") relaying DOWN "+s+" to "+o+" - "+JSON.stringify(i)))),!0)}function p(e,n,t){if(e in D)for(var i=0;i<D[e].length;i++)"function"==typeof t?D[e][i].fn.call(D[e][i],n,t):D[e][i].fn.call(D[e][i],n)}function _(e){if(!e)return!1;var n=v(e).level;return n in O}function v(e){var n=e.split("@");return{level:n[0],tab_id:n.length>0?parseInt(n[1],10):null}}function y(e,n){return e+"@"+n}function h(e){M&&console.log("::MSG-RELAY ("+N+"):: "+e)}function x(e,n){var t=f(e,N,!0,n);t.msg_from="mock",d(t,null,{tabId:999})}function b(){J=setInterval(function(){var e=1,n=0;for(var t in w)w[t]===n?w[t]=e:delete w[t]},1e3*I)}var M=t||!1,O={extension:"extension",content:"content",page:"page",iframe:"iframe",iframe_shim:"iframe_shim",test:"test"},S={extension:4,content:3,page:2,iframe_shim:1,iframe:0,test:-1},N=n,w={},J=null,I=120,L=e,T=null,E=null,D={};if(b(),N!==O.test&&([O.page,O.content,O.iframe,O.iframe_shim].indexOf(N)!==-1&&window.addEventListener("message",function(e){"object"==typeof e.data&&"msg_namespace"in e.data&&e.data.msg_namespace===L&&d(e.data)}),[O.content,O.extension].indexOf(N)!==-1))try{chrome.runtime.onMessage.addListener(function(e,n,t){d(e,t,n)})}catch(W){}return{levels:O,on:i,off:s,offAll:r,send:m,levelViaTabId:y,getLastMsgSenderInfo:function(){return T},getLastMsgType:function(){return E},mockSend:x}};"undefined"!=typeof module&&module.exports?module.exports=e:window.chrome_extension_message_relay=e}();