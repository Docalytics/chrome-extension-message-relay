/* Version 3.0.1 chrome-extension-message-relay (https://github.com/ecaroth/chrome-extension-message-relay), Authored by Evan Carothers */

export const relay=(e=>function(t,n,i,s){s||(s="*");const r=i||!1,o=Object.freeze({service_worker:"service_worker",content:"content",page:"page",iframe:"iframe",iframe_shim:"iframe_shim",test:"test"}),a=Object.freeze({service_worker:4,content:3,page:2,iframe_shim:1,iframe:0,test:-1}),l=n;let c={},m=null,f=t,u=null,d=null,g={},p=[],h={},_=!1;const y="_CSTATE",$=Object.freeze({ready:"ready",initEnv:"initEnv",initialized:"initalized"}),v={},b="***";function I(e,t,n=null,i=!1,s=null){"string"==typeof e&&(e=[e]),n&&!Array.isArray(n)&&(n=[n]),e.forEach((e=>{let r=O(e);r.type in g||(g[r.type]=[]),g[r.type].push({fn:t,ns:r.namespace,limitFromLevels:n,componentFilter:s,isOnce:i})}))}function w(e,t=null){e&&("string"==typeof e&&(e=[e]),e.forEach((e=>{let t=O(e);t.type in g&&(t.namespace?C(t.type,t.namespace):delete g[t.type])})))}function E(e,t=null,n=null){let i=e;return t&&(i+="."+t),n&&(i+=`[${n}]`),i}function O(e){let t=null,n=null,i=null;const s=(e=e.split("@@@")[0]).match(/^([\w:_-]+)\.?([\w:_-]+)?(\[(.+)])?$/);return s[2]?(n=s[2],t=s[1]):t=s[1],s[4]&&(i=s[4]),{type:t,namespace:n,component:i}}function C(e,t){e in g&&(g[e]=g[e].filter((e=>e.ns!==t)),g[e].length||delete g[e])}function S(e,t,n,i,s){let r="msgId"in(s=L(s))?s.msgId:function(e,t){return`${e}:${t}@@@${R()}`}(t,e);s.msgId=r;let o={msgType:e,msgFrom:l,sourceLevel:n,msgDestination:t,msgUp:i,relayNamespace:f,msgData:s,msgId:r,msgTabId:null};const a=A(t);return a.tabId&&(o.msgDestination=a.level,o.msgTabId=a.tabId),o}function M(e,t,n,i=null){if(n=L(n),"string"==typeof t&&(t=[t]),i){const t=O(e);e=E(t.type,t.namespace,i)}t.forEach((t=>{if(!function(e){return!!e&&A(e).level in o}(t))return W(`NOTICE - invalid level specified as destination (${t})`);const i=A(t).level;a[i]<a[l]?N(e,t,n):function(e,t,n){const i=S(e,t,l,!0,n);W(`Send msg UP from ${l} to ${t} : ${e} - ${JSON.stringify(n)}`),T(i)}(e,t,n)}))}function N(e,t,n={}){const i=S(e,t,l,!1,n);W(`Send msg DOWN from ${l} to ${t} : ${e} - ${JSON.stringify(n)}`),T(i)}function T(t){!function(t,n){if(t===o.content&&n.msgDestination===o.service_worker||t===o.service_worker);else if(t===o.iframe||n.msgDestination!==o.iframe&&t===o.iframe_shim)e.parent.postMessage(n,s);else if(t!==o.page&&t!==o.content||![o.iframe,o.iframe_shim].includes(n.msgDestination))if(n.msgDestination===o.iframe&&t===o.iframe_shim)for(let t=0;t<e.frames.length;t++)e.frames[t].postMessage(n,"*");else e.postMessage(n,"*");else{const e=document.getElementsByTagName("iframe"),{component:t}=O(n.msgType);for(let i=0;i<e.length;i++){if(t&&!t.startsWith(b)&&e[i].getAttribute(z(t))!==$.ready)continue;let s="*";(l!==o.content||(s="chrome-extension://"+chrome.runtime.id,e[i].src.startsWith(s)))&&e[i].contentWindow.postMessage(n,s)}}}(l,t)}function D(e,t){const{msgData:n,msgFrom:i,sourceLevel:s,msgUp:r,msgDestination:m,msgType:f,msgId:_}=e;t&&(u=t),d=O(f);const v=`${_}:${m}`;if(i===l||v in c)return!1;m===l?(W(`Msg (${f}) received from ${i} to ${m} - ${JSON.stringify(n)}`),c[v]=0,function(e,t,n){delete t.msgId,delete t.msg_id;const{component:i,namespace:s,type:r}=O(e);if(i&&[o.content,o.page].includes(l)){const e=u,t=Array.from(document.getElementsByTagName("iframe")).find((t=>t.contentWindow===e));if(s===y){if(r===$.ready){W(`Component ${i} is ready`);const e=z(i);t.setAttribute(e,$.ready);let n=function(e,t){return E(e,y,t)}($.initEnv,i);return N(n,o.iframe,h)}if(r===$.initialized){const e=k(i);p.forEach((n=>{n.name_filter&&0!==e.localeCompare(n.name_filter)||n.fn(e,t,u)}))}}}if(!(r in g))return;g[r].forEach(((e,s)=>{const a=e.limitFromLevels;if(!a||a.includes(n)){if(i&&[o.page,o.content,o.iframe_shim].includes(l)){const t=e.componentFilter;if(t!==b){if(!t.startsWith(b)&&i!==t)return;if(t.startsWith(b)){if(k(i)!==t.replace(b,""))return}}}e.fn.call(e,t),e.isOnce&&delete g[r][s]}}))}(f,n,s)):(e.msgFrom=l,r&&a[l]>a[i]?(T(e),W(`Msg (${f}) relaying UP from ${i} to ${m} - ${JSON.stringify(n)}`)):!r&&a[l]<a[i]&&(T(e),W(`Msg (${f}) relaying DOWN ${i} to ${m} - ${JSON.stringify(n)}`)))}function z(e){return"relay-component-"+e.replace(/[\W]/g,"-").replace(/-+$/,"")}function k(e){const t=e.match(/^(.+){[a-z0-9-]+}$/);return t?t[1]:null}function A(e){let t=e.split("@"),n=t.length>0?parseInt(t[1],10):null;return{level:t[0],tab_id:n,tabId:n}}function L(e){if(null==e&&(e={}),"object"!=typeof e)throw new j("Data payload for message must be an object");let t;try{t=JSON.parse(JSON.stringify(e))}catch(e){throw new j("Data payload for message included non-JSON-serizable data")}return t}function W(e){r&&console.log(`::MSG-RELAY (${l}):: ${e}`)}function F(e,t){t=L(t);const n=S(e,l,l,!0,t);n.msgFrom="mock",D(n,{tabId:999})}function J(){for(let e in c)0===c[e]?c[e]=1:delete c[e]}function R(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}function j(e){this.name="ChromeExtensionMessageRelayError",this.message=e||"Error in chrome extension message relay",this.stack=(new Error).stack}if(m=setInterval(J,12e4),j.prototype=Object.create(Error.prototype),j.prototype.constructor=j,!(l!==o.content&&l!==o.service_worker||chrome&&chrome.runtime&&chrome.runtime.id)){throw new j(`ERROR - invalid context detected for ${l}, aborting.`)}l!==o.test&&([o.page,o.content,o.iframe,o.iframe_shim].includes(l)&&e.addEventListener("message",(e=>{if("object"!=typeof e.data)return;const t=(e=>{if("msg_namespace"in e){let t={};for(let n in e)"msg_namespace"===n?t.relayNamespace=e.msg_namespace:t[n.replace(/_[a-z]/g,(e=>`${e.toUpperCase()}`.replace("_","")))]=e[n];return t}return e})(e.data);"relayNamespace"in t&&t.relayNamespace===f&&D(t,e.source)})),o.content,o.service_worker);const x={levels:o,curLevel:()=>l,on:I,onOnce:(e,t,n=null)=>{I(e,t,n,!0)},off:e=>{w(e)},componentOff:(e,t)=>{w(e,t)},offAll:function(e){if(e)for(let t in g)C(t,e);else g={}},send:M,levelViaTabId:function(e,t){return`${e}@${t}`},levelViaComponentId:function(e){return`${l}@${e}`},getLastMsgSenderInfo:()=>u,getLastMsgType:()=>d.type,getLastMsg:()=>d,mockSend:F,localSend:F,componentSend:function(e,t={},n=null){const i=O(e),s=b+(n||"");if(e=E(i.type,i.namespace,s),l===o.iframe)return F(e,t);N(e,o.iframe)},componentOn:function(e,t,n,i){if(![o.page,o.content,o.iframe_shim].includes(l))throw new j("Cannot bind component on listeners in this level");const s=b+t;I(e,n,[o.iframe,o.iframe_shim],i,s)},componentRespond:function(e,t){const n=d;n.component&&M(e,o.iframe,t,n.component)},clearTMO:function(){clearInterval(m)},registerComponentInitializedCb:(e,t=null)=>{p.push({fn:e,name_filter:t})},setComponentEnvData:e=>{h=e},setOverrideLocalComponentInit:e=>{h=e,_=!0},getComponentEnvData:()=>h};class U{constructor(e,t,n=!1){this.enabled=!0,this._relay=e,this._componentName=t,this._componentId=`${t}{${R()}}`,this._debug=n,this._ready=!1,this._initialized=!1,this._pendingInitCalls=[]}get _initMsg(){return`${$.initEnv}._CSTATE`}markReady(e=null){const t=e=>{if(this._ready)return;if(this._log("markReady"),!this.enabled)return;const t=t=>{for(e(t);this._pendingInitCalls.length;){let e=this._pendingInitCalls.shift();e.cb(e.data)}this.off(this._initMsg)};_?t(h):(this.on(this._initMsg,t),this.send(`${$.ready}._CSTATE`)),this._ready=!0};return e?t(e):new Promise((e=>{t(e)}))}markInitialized(){this._initialized||(this._log("MarkInitialized"),this.enabled&&(this._initialized=!0,this.send(`${$.initialized}._CSTATE`)))}_log(...e){if(!this._debug)return;const t=Array.from(arguments);t.unshift(`[${this.enabled?"":"DISABLED "}COMPONENT ${this._componentId}`),console.warn(...t)}onOnce(e,t){this.on(e,t,!0)}on(e,t,n=!1){if(this._log(">>> .on"+(n?"Once":""),e),!this.enabled)return;let i=[this._relay.levels.page,this._relay.levels.content,this._relay.levels.iframe_shim];this._relay.on(e,(n=>{if(this._log(">>> .on called",e,n),!this._ready&&e!==this._initMsg)return this._pendingInitCalls.push({cb:t,data:n});t(n)}),i,n,this._componentId)}send(e,t={}){if(this._log(">>> .send",e,t),!this.enabled)return;let n=[this._relay.levels.page,this._relay.levels.content];this._relay.send(e,n,t,this._componentId)}off(e){this._log(">>> .off",e),this._relay.componentOff(e,this._componentId)}}return x.newComponent=(e,t=!1)=>{if(l!==o.iframe&&!_)throw new j("You can only create a component in an iframe level.");let n=new U(x,e,t);return v[n.id]=n,n},x})(void 0!==this?this:"undefined"==typeof window?{}:window);