/* Version 2.0.2 chrome-extension-message-relay (https://github.com/ecaroth/chrome-extension-message-relay), Authored by Evan Carothers */

"use strict";const relay=function(e,n,t){const i=t||!1,s=Object.freeze({extension:"extension",content:"content",page:"page",iframe:"iframe",iframe_shim:"iframe_shim",test:"test"}),a=Object.freeze({extension:4,content:3,page:2,iframe_shim:1,iframe:0,test:-1}),o=n;let r={},f=null,l=e,m=null,g=null,c={},d={},u=null;function p(e){let n=e.split(".");return{type:n.splice(0,1)[0],namespace:n.length>0?n.join("."):null}}function _(e,n){if(e in c)for(let t=c[e].length-1;t>=0;t--)c[e][t].ns===n&&c[e].splice(t,1)}function $(e,n,t,i){i||(i={});let s="msg_id"in i?i.msg_id:`${n}:${e}:${(new Date).getTime()}`;i.msg_id=s;let a={msg_type:e,msg_from:o,msg_destination:n,msg_up:t,msg_namespace:l,msg_data:i,msg_id:s,msg_tab_id:null},r=b(n);return r.tab_id&&(a.msg_destination=r.level,a.msg_tab_id=r.tab_id),a}function y(e){!function(e,n){if(e===s.extension)if(n.msg_tab_id)d[n.msg_tab_id]=d[n.msg_tab_id]||[],d[n.msg_tab_id].push(n);else for(var t in d)d[t].push(n);else if(e===s.content&&n.msg_destination===s.extension||e===s.extension)u.postMessage(n);else if(e===s.iframe||e===s.iframe_shim)window.parent.postMessage(n,"*");else if(e!==s.page&&e!==s.content||n.msg_destination!==s.iframe)window.postMessage(n,"*");else{let e=document.getElementsByTagName("iframe");for(let t=0;t<e.length;t++)try{e[t].contentWindow.postMessage(n,"*")}catch(e){}}}(o,e)}function h(e,n){let{msg_data:t,msg_from:i,msg_up:s,msg_destination:f,msg_type:l,msg_id:d}=JSON.parse(JSON.stringify(e));n&&(m=n),g=l;let u=`${d}:${f}`;if(i===o||u in r)return!1;f===o?(v(`Msg (${l}) received from ${i} to ${f} - ${JSON.stringify(t)}`),r[u]=0,function(e,n){if(!(e in c))return;c[e].forEach(e=>{e.fn.call(e,n)})}(l,t)):(e.msg_from=o,s&&a[o]>a[i]?(y(e),v(`Msg (${l}) relaying UP from ${i} to ${f} - ${JSON.stringify(t)}`)):!s&&a[o]<a[i]&&(y(e),v(`Msg (${l}) relaying DOWN ${i} to ${f} - ${JSON.stringify(t)}`)))}function b(e){let n=e.split("@");return{level:n[0],tab_id:n.length>0?parseInt(n[1],10):null}}function v(e){i&&console.log(`::MSG-RELAY (${o}):: ${e}`)}function M(e,n){let t=$(e,o,!0,n);t.msg_from="mock",h(t,{tabId:999})}return f=setInterval(function(){for(let e in r)0===r[e]?r[e]=1:delete r[e]},1e3*120),o!==s.test&&([s.page,s.content,s.iframe,s.iframe_shim].includes(o)&&window.addEventListener("message",function(e){"object"==typeof e.data&&"msg_namespace"in e.data&&e.data.msg_namespace===l&&h(e.data)}),o===s.content&&(v("Alerting extension of ready"),(u=chrome.runtime.connect({name:e})).onMessage.addListener(e=>{h(e)})),o===s.extension&&chrome.runtime.onConnect.addListener(n=>{n.name===e&&function(e){let n=e.sender.tab.id,t=Array.isArray(d[n])?d[n].slice():[];e.onDisconnect.addListener(e=>{delete d[e.sender.tab.id]}),e.onMessage.addListener(n=>{h(n,e.sender)}),d[n]={push:n=>{e.postMessage(n)}},t.forEach(e=>d[n].push(e))}(n)})),{levels:s,on:function(e,n){"string"==typeof e&&(e=[e]),e.forEach(e=>{let t=p(e);t.type in c||(c[t.type]=[]),c[t.type].push({fn:n,ns:t.namespace})})},off:function(e){"string"==typeof e&&(e=[e]),e.forEach(e=>{let n=p(e);n.type in c&&(n.namespace?_(n.type,n.namespace):delete c[n.type])})},offAll:function(e){if(e)for(let n in c)_(n,e);else c={}},send:function(e,n,t){"string"==typeof n&&(n=[n]),n.forEach(n=>{if(!((n=n)&&b(n).level in s))return v(`NOTICE - invalid level specified as destination (${n})`);let i=b(n).level;a[i]<a[o]?function(e,n,t){let i=$(e,n,!1,t);v(`Send msg DOWN from ${o} to ${n} : ${e} - ${JSON.stringify(t)}`),y(i)}(e,n,t):function(e,n,t){let i=$(e,n,!0,t);v(`Send msg UP from ${o} to ${n} : ${e} - ${JSON.stringify(t)}`),y(i)}(e,n,t)});var i},levelViaTabId:function(e,n){return`${e}@${n}`},getLastMsgSenderInfo:()=>m,getLastMsgType:()=>g,mockSend:M,localSend:M}};export {relay};